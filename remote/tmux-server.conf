# Server tmux config (synced from local via _sync_claude_config)
# Matches local tmux.conf with Linux adaptations

# Mouse & history
set -g mouse on
set -g history-limit 50000

# Terminal compatibility
set -g default-terminal "tmux-256color"
set -as terminal-features ",xterm-256color:RGB"
set -ag terminal-overrides ",xterm-256color:Tc"
set -as terminal-overrides ',*:sitm=\E[3m:ritm=\E[23m'
set -sg escape-time 10

# Force zsh (fallback if chsh failed)
set -g default-shell /usr/bin/zsh

# Allow OSC 7 passthrough (passes through SSH to Ghostty)
set -g allow-passthrough all

# Start indexing at 1
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Quiet
set -g visual-bell off
set -g bell-action none

# ── Status bar (toggle: prefix + S) ──
set -g status on
set -g status-position bottom
set -g status-interval 30
bind S set -g status

set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

# Left: session name bubble — project in blue, status suffix dimmed
set -g status-left-length 50
set -g status-left "#[fg=#313244,bg=#1e1e2e]#[fg=#89b4fa,bg=#313244] #{s/ - .*$//:session_name}#[fg=#7f849c]#{?#{m:* - *,#S}, - #{s/^.* - //:session_name},} #[fg=#313244,bg=#1e1e2e] "

# Right: empty
set -g status-right-length 1
set -g status-right ""

# Windows
set -g status-justify left
setw -g window-status-format "#{?#{==:#W,_spare},,#[fg=#6c7086,bg=#1e1e2e] #I:#W }"
setw -g window-status-current-format "#{?#{==:#W,_spare},,#[fg=#313244]#[fg=#b4befe,bg=#313244,bold] #I:#W #[fg=#313244,bg=#1e1e2e,nobold] }"
setw -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=#313244"
set -g pane-active-border-style "fg=#6c7086"

# Messages & mode
set -g message-style "bg=#313244,fg=#cdd6f4"
set -g message-command-style "bg=#313244,fg=#cdd6f4"
setw -g mode-style "bg=#45475a,fg=#cdd6f4"

# Dev workspace: rotate bottom-right pane (no-op outside dev sessions)
# Reads pane IDs from session env vars set by _setup_dev_layout
bind y run-shell 'S="#{session_name}";A=$(tmux show-env -t "$S" DEV_ACTIVE 2>/dev/null)||exit 0;A=${A#*=};[ "$A" = YAZI ]&&exit 0;C=$(tmux show-env -t "$S" DEV_$A 2>/dev/null)||exit 1;C=${C#*=};P=$(tmux show-env -t "$S" DEV_YAZI 2>/dev/null)||exit 1;P=${P#*=};[ -n "$P" ]&&[ -n "$C" ]&&tmux swap-pane -d -s "$P" -t "$C"&&tmux set-env -t "$S" DEV_ACTIVE YAZI'
bind u run-shell 'S="#{session_name}";A=$(tmux show-env -t "$S" DEV_ACTIVE 2>/dev/null)||exit 0;A=${A#*=};[ "$A" = CLAUDE ]&&exit 0;C=$(tmux show-env -t "$S" DEV_$A 2>/dev/null)||exit 1;C=${C#*=};P=$(tmux show-env -t "$S" DEV_CLAUDE 2>/dev/null)||exit 1;P=${P#*=};[ -n "$P" ]&&[ -n "$C" ]&&tmux swap-pane -d -s "$P" -t "$C"&&tmux set-env -t "$S" DEV_ACTIVE CLAUDE'
bind i run-shell 'S="#{session_name}";A=$(tmux show-env -t "$S" DEV_ACTIVE 2>/dev/null)||exit 0;A=${A#*=};[ "$A" = SHELL ]&&exit 0;C=$(tmux show-env -t "$S" DEV_$A 2>/dev/null)||exit 1;C=${C#*=};P=$(tmux show-env -t "$S" DEV_SHELL 2>/dev/null)||exit 1;P=${P#*=};[ -n "$P" ]&&[ -n "$C" ]&&tmux swap-pane -d -s "$P" -t "$C"&&tmux set-env -t "$S" DEV_ACTIVE SHELL'

# Terminal title (session name → Ghostty tab title via set-titles-string)
# Format: [R] {type}{base}{ - status}
set -g set-titles on
set -g set-titles-string "#S"

# Dynamically update session name with Claude status
# Always uses [R] prefix (remote location)
# Detects worktree type: [wt] for worktrees (.git is a file)
# No [ws] workspace detection (workspaces not on server)
set-hook -g pane-title-changed 'run-shell "base=\$(tmux display -p \"#S\" | sed \":a; s/^\\[R\\] //; ta; s/^\\[wt\\] //\" | sed \"s/ - .*//\"); t=\$(printf \"%s\" \"#{pane_title}\" | sed \"s/^[✳✻*] //\"); case \"\$t\" in \\[R\\]*) pfx=\"\"; st=\$(printf \"%s\" \"\$t\" | sed -n \"s/.* - //p\") ;; *) pane_path=\"#{pane_current_path}\"; pfx=\"\"; [ -f \"\$pane_path/.git\" ] && pfx=\"[wt] \"; st=\"\$t\" ;; esac; [ -n \"\$st\" ] && tmux rename-session \"[R] \${pfx}\${base} - \${st}\" || tmux rename-session \"[R] \${pfx}\${base}\""'

# Note: Claude Code has known buffer sync issues with tmux (GitHub #4851, #2479)
# The /clear command doesn't properly sync with tmux's display on detach/reattach
# Workaround: use /quit to fully restart Claude Code if display gets corrupted
