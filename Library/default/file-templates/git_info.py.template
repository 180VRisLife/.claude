"""
git_info.py
{{PROJECT_NAME}}

Git state information helper for debug builds
Auto-generated by /init-workspace

Usage:
    from git_info import get_git_info

    git_info = get_git_info()
    print(git_info)  # [main@a1b2c3d]
"""

import subprocess
from typing import Optional


def get_git_info() -> str:
    """
    Get formatted git info string: [branch@hash] or [@hash]

    Examples:
        - Normal branch: "[main@a1b2c3d]"
        - Detached HEAD: "[@a1b2c3d]"
        - Dirty state: "[main@a1b2c3d*]"
        - Not a git repo: "[unknown]"

    Returns:
        Formatted git info string
    """
    try:
        branch = _exec_git(['git', 'rev-parse', '--abbrev-ref', 'HEAD'])
        hash = _exec_git(['git', 'rev-parse', '--short', 'HEAD'])

        if not branch or not hash:
            return "[unknown]"

        status = _exec_git(['git', 'status', '--porcelain'])
        dirty = '*' if status and status.strip() else ''

        if branch == 'HEAD':
            # Detached HEAD
            return f"[@{hash}{dirty}]"
        else:
            return f"[{branch}@{hash}{dirty}]"

    except Exception:
        return "[unknown]"


def get_git_components() -> dict:
    """
    Get individual git info components

    Returns:
        Dictionary with 'branch', 'hash', 'is_dirty' keys
    """
    try:
        branch = _exec_git(['git', 'rev-parse', '--abbrev-ref', 'HEAD'])
        hash = _exec_git(['git', 'rev-parse', '--short', 'HEAD'])
        status = _exec_git(['git', 'status', '--porcelain'])

        is_detached = branch == 'HEAD'

        return {
            'branch': None if is_detached else branch,
            'hash': hash,
            'is_dirty': bool(status and status.strip()),
            'is_detached': is_detached
        }
    except Exception:
        return {
            'branch': None,
            'hash': None,
            'is_dirty': False,
            'is_detached': False
        }


def _exec_git(command: list) -> Optional[str]:
    """Execute git command and return output"""
    try:
        result = subprocess.run(
            command,
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout.strip()
    except (subprocess.CalledProcessError, FileNotFoundError):
        return None


if __name__ == '__main__':
    # Test the git info
    print("Git Info:", get_git_info())
    print("Components:", get_git_components())
