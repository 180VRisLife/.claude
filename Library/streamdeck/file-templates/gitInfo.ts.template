/**
 * gitInfo.ts
 * {{PLUGIN_NAME}}
 *
 * Git state information helper for development builds
 * Auto-generated by /init-workspace
 */

import { execSync } from "child_process";

const IS_DEVELOPMENT = process.env.NODE_ENV === "development";

/**
 * Git state information for debug builds
 */
export class GitInfo {
	/**
	 * Get current branch name (or null if detached HEAD)
	 */
	private static get currentBranch(): string | null {
		if (!IS_DEVELOPMENT) return null;

		try {
			const branch = execSync("git rev-parse --abbrev-ref HEAD", {
				encoding: "utf8",
				stdio: ["pipe", "pipe", "ignore"]
			}).trim();

			return branch === "HEAD" ? null : branch;
		} catch {
			return null;
		}
	}

	/**
	 * Get short commit hash (7 characters)
	 */
	private static get commitHash(): string | null {
		if (!IS_DEVELOPMENT) return null;

		try {
			return execSync("git rev-parse --short HEAD", {
				encoding: "utf8",
				stdio: ["pipe", "pipe", "ignore"]
			}).trim();
		} catch {
			return null;
		}
	}

	/**
	 * Check if there are uncommitted changes
	 */
	private static get isDirty(): boolean {
		if (!IS_DEVELOPMENT) return false;

		try {
			const status = execSync("git status --porcelain", {
				encoding: "utf8",
				stdio: ["pipe", "pipe", "ignore"]
			}).trim();

			return status.length > 0;
		} catch {
			return false;
		}
	}

	/**
	 * Formatted git info string for display
	 * Examples:
	 * - Normal branch: "[main@a1b2c3d]"
	 * - Detached HEAD: "[@a1b2c3d]"
	 * - Dirty state: "[main@a1b2c3d*]"
	 * - Not a git repo: "[unknown]"
	 */
	static get displayString(): string {
		if (!IS_DEVELOPMENT) return "";

		const hash = this.commitHash;
		if (!hash) return "[unknown]";

		const branch = this.currentBranch;
		const dirtyIndicator = this.isDirty ? "*" : "";

		if (branch) {
			return `[${branch}@${hash}${dirtyIndicator}]`;
		} else {
			// Detached HEAD
			return `[@${hash}${dirtyIndicator}]`;
		}
	}

	/**
	 * Get individual git info components
	 */
	static get info() {
		if (!IS_DEVELOPMENT) {
			return { branch: null, hash: null, isDirty: false };
		}

		return {
			branch: this.currentBranch,
			hash: this.commitHash,
			isDirty: this.isDirty
		};
	}
}
