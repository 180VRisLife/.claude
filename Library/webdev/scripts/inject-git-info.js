#!/usr/bin/env node
/**
 * inject-git-info.js
 *
 * Injects git information into environment variables at build time
 * Auto-generated by /init-workspace
 *
 * Usage:
 *   node inject-git-info.js [env-file]
 *
 * Example:
 *   node inject-git-info.js .env.development.local
 *   node inject-git-info.js .env.production.local
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

/**
 * Execute git command and return output
 */
function execGit(command) {
	try {
		return execSync(command, {
			encoding: 'utf8',
			stdio: ['pipe', 'pipe', 'ignore']
		}).trim();
	} catch (error) {
		return null;
	}
}

/**
 * Get git information
 */
function getGitInfo() {
	const branch = execGit('git rev-parse --abbrev-ref HEAD');
	const hash = execGit('git rev-parse --short HEAD');
	const buildTime = new Date().toISOString();

	return {
		branch: branch || 'unknown',
		hash: hash || 'unknown',
		buildTime
	};
}

/**
 * Inject git info into environment file
 */
function injectGitInfo(envFilePath) {
	const gitInfo = getGitInfo();

	const envContent = `
# Git information (auto-injected by inject-git-info.js)
NEXT_PUBLIC_GIT_BRANCH=${gitInfo.branch}
NEXT_PUBLIC_GIT_HASH=${gitInfo.hash}
NEXT_PUBLIC_BUILD_TIME=${gitInfo.buildTime}
`;

	// Ensure file exists
	if (!fs.existsSync(envFilePath)) {
		fs.writeFileSync(envFilePath, '');
		console.log(`âœ“ Created ${envFilePath}`);
	}

	// Read existing content
	const existingContent = fs.readFileSync(envFilePath, 'utf8');

	// Remove any existing git info lines
	const cleanedContent = existingContent
		.split('\n')
		.filter(line => !line.includes('NEXT_PUBLIC_GIT_') && !line.includes('NEXT_PUBLIC_BUILD_TIME'))
		.join('\n')
		.trim();

	// Append new git info
	const newContent = cleanedContent + '\n' + envContent;

	fs.writeFileSync(envFilePath, newContent);

	console.log(`âœ“ Injected git info into ${envFilePath}`);
	console.log(`  Branch: ${gitInfo.branch}`);
	console.log(`  Hash: ${gitInfo.hash}`);
	console.log(`  Build Time: ${gitInfo.buildTime}`);
}

// Main execution
function main() {
	const args = process.argv.slice(2);
	const envFile = args[0] || '.env.development.local';
	const envFilePath = path.resolve(process.cwd(), envFile);

	console.log('\nðŸ”§ Injecting git information...');
	console.log(`   Target: ${envFile}\n`);

	injectGitInfo(envFilePath);

	console.log('\nâœ… Git information injected successfully!');
	console.log('   Add this script to your package.json:');
	console.log('   "scripts": {');
	console.log('     "dev": "node .claude/scripts/inject-git-info.js .env.development.local && next dev",');
	console.log('     "build": "node .claude/scripts/inject-git-info.js .env.production.local && next build"');
	console.log('   }');
}

if (require.main === module) {
	main();
}

module.exports = { getGitInfo, injectGitInfo };
