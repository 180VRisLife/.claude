//
//  GitInfo.swift
//  {{PROJECT_NAME}}
//
//  Git state information helper for debug builds
//  Auto-generated by /init-workspace
//

import Foundation

#if DEBUG

/// Git state information for debug builds
struct GitInfo {

    // MARK: - Git State Detection

    /// Get current branch name (or nil if detached HEAD)
    private static var currentBranch: String? {
        guard let output = shell("git rev-parse --abbrev-ref HEAD") else {
            return nil
        }
        let branch = output.trimmingCharacters(in: .whitespacesAndNewlines)
        return branch == "HEAD" ? nil : branch
    }

    /// Get short commit hash (7 characters)
    private static var commitHash: String? {
        guard let output = shell("git rev-parse --short HEAD") else {
            return nil
        }
        return output.trimmingCharacters(in: .whitespacesAndNewlines)
    }

    /// Check if there are uncommitted changes
    private static var isDirty: Bool {
        guard let output = shell("git status --porcelain") else {
            return false
        }
        return !output.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty
    }

    /// Check if we're in a git worktree
    private static var isWorktree: Bool {
        guard let output = shell("git rev-parse --git-dir") else {
            return false
        }
        return output.contains("/worktrees/")
    }

    // MARK: - Public Display String

    /// Formatted git info string for display
    /// Examples:
    /// - Normal branch: "[main@a1b2c3d]"
    /// - Detached HEAD: "[@a1b2c3d]"
    /// - Dirty state: "[main@a1b2c3d*]"
    /// - Not a git repo: "[unknown]"
    static var displayString: String {
        guard let hash = commitHash else {
            return "[unknown]"
        }

        let branch = currentBranch
        let dirtyIndicator = isDirty ? "*" : ""

        if let branch = branch {
            return "[\(branch)@\(hash)\(dirtyIndicator)]"
        } else {
            // Detached HEAD
            return "[@\(hash)\(dirtyIndicator)]"
        }
    }

    // MARK: - Helper

    /// Execute shell command and return output
    private static func shell(_ command: String) -> String? {
        let task = Process()
        let pipe = Pipe()

        task.standardOutput = pipe
        task.standardError = pipe
        task.arguments = ["-c", command]
        task.executableURL = URL(fileURLWithPath: "/bin/zsh")
        task.standardInput = nil

        do {
            try task.run()

            let data = pipe.fileHandleForReading.readDataToEndOfFile()
            return String(data: data, encoding: .utf8)
        } catch {
            return nil
        }
    }
}

#else

// MARK: - RELEASE Build Stub

/// No-op stub for RELEASE builds
struct GitInfo {
    static var displayString: String { "" }
}

#endif
